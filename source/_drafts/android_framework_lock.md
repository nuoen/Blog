title: android é”
author: nuoen
tags: []
categories:
  - cpp 
  - android
  - framework
date: 2025-03-29 21:39:00

## AutoMutex
åœºæ™¯ï¼š
```cpp
extern Mutex gDefaultServiceManagerLock;

sp<IServiceManager> defaultServiceManager()
{
    if (gDefaultServiceManager != nullptr) return gDefaultServiceManager;

    {
        AutoMutex _l(gDefaultServiceManagerLock);
        while (gDefaultServiceManager == nullptr) {
            gDefaultServiceManager = interface_cast<IServiceManager>(
                ProcessState::self()->getContextObject(nullptr));
            if (gDefaultServiceManager == nullptr)
                sleep(1);
        }
    }

    return gDefaultServiceManager;
}
```
å›¾ç¤ºï¼š
```
          Multiple Threads Call defaultServiceManager()
                         â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ if (gDefaultServiceManager != nullptr)â”‚  â† å·²åˆå§‹åŒ–å°±ç›´æ¥è¿”å›
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ AutoMutex _l(gDefaultServiceManagerLock); â”‚ â† æ‰€æœ‰çº¿ç¨‹éƒ½è¦åœ¨æ­¤æ’é˜ŸåŠ é”
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Thread A å…ˆè·å¾—é”â”‚                          â”‚Thread Bã€C ç­‰å¾…é” â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ gDefaultServiceManager == nullptr? æ˜¯
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Thread A å°è¯•åˆ›å»º ServiceManager å®ä¾‹          â”‚
â”‚gDefaultServiceManager = interface_cast(...)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆå§‹åŒ–æˆåŠŸï¼Œé‡Šæ”¾é” AutoMutex ææ„è‡ªåŠ¨ unlock â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Thread B/C è¢«å”¤é†’ï¼ŒåŠ é”åæ£€æŸ¥å˜é‡ä¸ä¸º null   â”‚
â”‚ if (gDefaultServiceManager != nullptr) returnâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
â€¢	è¿™æ˜¯å…¸å‹çš„çº¿ç¨‹å®‰å…¨ å•ä¾‹æ‡’åŠ è½½ï¼ˆlazy initializationï¼‰ï¼›
â€¢	ç”¨é”ä¿æŠ¤äº†â€œåªåˆå§‹åŒ–ä¸€æ¬¡â€çš„è¯­ä¹‰ï¼›
â€¢	æ•´ä½“éå¸¸é€‚åˆç”¨äºç³»ç»ŸæœåŠ¡çš„è·å–åœºæ™¯ï¼Œå¦‚ IServiceManagerã€‚

å®ç°åŸç†
system/core/include/utils/Mutex.h
```cpp
typedef Mutex::Autolock AutoMutex;

    class SCOPED_CAPABILITY Autolock {
      public:
        inline explicit Autolock(Mutex& mutex) ACQUIRE(mutex) : mLock(mutex) { mLock.lock(); }
        inline explicit Autolock(Mutex* mutex) ACQUIRE(mutex) : mLock(*mutex) { mLock.lock(); }
        inline ~Autolock() RELEASE() { mLock.unlock(); }

      private:
        Mutex& mLock;
        // Cannot be copied or moved - declarations only
        Autolock(const Autolock&);
        Autolock& operator=(const Autolock&);
    };

class CAPABILITY("mutex") Mutex {
  public:
    enum {
        PRIVATE = 0,
        SHARED = 1
    };

    Mutex();
    explicit Mutex(const char* name);
    explicit Mutex(int type, const char* name = nullptr);
    ~Mutex();

    // lock or unlock the mutex
    status_t lock() ACQUIRE();
    void unlock() RELEASE();

        pthread_mutex_t mMutex;

}

inline status_t Mutex::lock() {
    return -pthread_mutex_lock(&mMutex);
}

inline Mutex::~Mutex() {
    pthread_mutex_destroy(&mMutex);
}
```
è°ƒç”¨é€»è¾‘å°±æ˜¯ï¼š
1. å£°æ˜ä¸€ä¸ª AutoMutex å˜é‡ï¼Œä¹Ÿå°±æ˜¯Autolock -> Mutex& mLock;
2. Mutex& mLock å˜é‡ï¼ŒmLock->pthread_mutex_t 
3. AutoMutex _l(gDefaultServiceManagerLock); æ„é€ æ—¶ï¼Œè°ƒç”¨pthread_mutex_lock åŠ é”ï¼›
4. å˜é‡ _l,åœ¨ä½œç”¨åŸŸç»“æŸåï¼Œä¼šè°ƒç”¨å…¶ææ„å‡½æ•°,ä»è€Œè°ƒç”¨pthread_mutex_destroy ï¼Œä»è€Œè‡ªåŠ¨è§£é”ï¼›
é™„å½•ï¼š
## ä½œç”¨åŸŸ

âœ… ä»€ä¹ˆæ˜¯ä½œç”¨åŸŸï¼Ÿ
	â€¢	åœ¨ C++ ä¸­ï¼Œä½œç”¨åŸŸæ˜¯ { ... } å¤§æ‹¬å·åŒ…å›´çš„ä»£ç å—ã€‚
	â€¢	å˜é‡ï¼ˆæ¯”å¦‚ AutoMutex _lï¼‰çš„ç”Ÿå‘½å‘¨æœŸé™å®šåœ¨è¿™ä¸ªä»£ç å—å†…ã€‚
	â€¢	ä¸€æ—¦å‡ºäº†è¿™ä¸ªä½œç”¨åŸŸï¼Œå˜é‡ä¼šè¢«è‡ªåŠ¨ææ„ï¼ˆå³é‡Šæ”¾èµ„æºï¼‰ã€‚

â¸»

ğŸ¯ AutoMutex çš„ä½œç”¨åŸŸåœ¨å“ªï¼Ÿ
```cpp
{
    AutoMutex _l(gDefaultServiceManagerLock);
    ...
}
```
	â€¢	å¼€å§‹ï¼šAutoMutex _l(...) è¿™ä¸€è¡Œ
	â€¢	ç»“æŸï¼šç´§æ¥ç€çš„ } ç»“æŸå¤§æ‹¬å·
	â€¢	è¿™ä¸ªä½œç”¨åŸŸå†…åŠ é”ï¼Œé€€å‡ºä½œç”¨åŸŸæ—¶è‡ªåŠ¨è§£é”

â¸»

ğŸ”„ ç”Ÿå‘½å‘¨æœŸè¿‡ç¨‹å›¾è§£

defaultServiceManager()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ if (gDefaultServiceManager != nullptr) ...â”‚ â† å·²åˆå§‹åŒ–ç›´æ¥è¿”å›
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ {                                          â”‚ â† è¿›å…¥ä½œç”¨åŸŸï¼ˆåŠ é”ï¼‰
â”‚   AutoMutex _l(lock);                      â”‚ â† æ„é€ ï¼ŒåŠ é”
â”‚   while (...) { ... }                      â”‚
â”‚ }                                          â”‚ â† é€€å‡ºä½œç”¨åŸŸï¼ˆææ„ -> è§£é”ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ return gDefaultServiceManager;            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜



â¸»

ğŸš¦ ä¸ºä»€ä¹ˆä¸æ•´ä¸ªå‡½æ•°éƒ½é”ä½ï¼Ÿ
	â€¢	å¦‚æœæŠŠ AutoMutex _l(...) æ”¾åœ¨å‡½æ•°é¡¶éƒ¨ï¼Œå³ä½¿å˜é‡å·²åˆå§‹åŒ–ï¼Œä¹Ÿä¼šåŠ é”ç­‰å¾…ï¼Œæµªè´¹æ€§èƒ½ã€‚
	â€¢	é€šè¿‡ä½œç”¨åŸŸé™åˆ¶ï¼Œåªåœ¨ gDefaultServiceManager ä¸º nullptr æ—¶æ‰åŠ é”ï¼Œæ›´é«˜æ•ˆã€‚

â¸»

âœ… æ€»ç»“è¡¨æ ¼
é—®é¢˜	è§£ç­”
AutoMutex çš„ä½œç”¨åŸŸæ˜¯ï¼Ÿ	åŒ…å›´å…¶å®šä¹‰çš„å¤§æ‹¬å· { ... }
ä½•æ—¶å¼€å§‹å’Œç»“æŸï¼Ÿ	ä» AutoMutex _l(...) å¼€å§‹ï¼Œåˆ°å…¶å¯¹åº”çš„ } ç»“æŸ
ä¸ºä½•ç”¨ä½œç”¨åŸŸåŒ…ä½ï¼Ÿ	è‡ªåŠ¨åŠ è§£é”ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼ŒåŒæ—¶æé«˜æ€§èƒ½
é€€å‡ºä½œç”¨åŸŸåä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ	è°ƒç”¨ ~AutoMutex() â†’ è‡ªåŠ¨è°ƒç”¨ unlock() è§£é”
â¸»